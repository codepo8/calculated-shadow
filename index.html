<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calculated drop shadow</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <style type="text/css" media="screen">
    *{margin:0;padding:0;font-family:helvetica,arial,sans-serif}
    h1{margin:1em 0;font-size:20px;}
    footer,section,header,canvas,nav{display:block;}
    canvas{border:1px solid #fff;background:#369;float:left;
    margin-right:10px;width:300px;height:300px}
    body{background:#333;color:#ccc;padding:3em;}
    nav{overflow:hidden;margin:2em 0;}
    form{float:left;}
    li{list-style:none;}
    ul{margin:1em 0;background:rgba(0,0,0,0.7);width:15em;padding:1em;border-radius:10px;}
    h1{color:#fff;font-weight:normal;}
    footer{clear:both;font-size:12px;padding:2em 0}
    footer a{color:lime;}
  </style>
</head>
<body>
  <header><h1>Calculated drop shadow</h1></header>
  
  <section><canvas></canvas>
  <form>
    <div><input type="checkbox" id="controlline">
    <label for="controlline">show control line</label></div>
    <div><input type="checkbox" id="animate" checked>
    <label for="animate">Animate (disable for mouse control)</label></div>
    <output></output>
  </form></section>
  <footer>
  <p>Written by 
    <a href="http://wait-till-i.com/">Chris Heilmann</a> - 
    <a href="http://twitter.com/codepo8">@codepo8</a>
  </p></footer>
<script>

if ( !window.requestAnimationFrame ) {
  window.requestAnimationFrame = ( function() {
    return window.webkitRequestAnimationFrame ||
    window.mozRequestAnimationFrame ||
    window.oRequestAnimationFrame ||
    window.msRequestAnimationFrame ||
    function( /* function FrameRequestCallback */ callback, /* DOMElement Element */ element ) {
      window.setTimeout( callback, 1000 / 60 );
    };
  } )();
}

// grab the canvas element, get the context for API access and 
// preset some variables
var canvas = document.querySelector( 'canvas' ),
    c = canvas.getContext( '2d' ),
    mouseX = 0,
    mouseY = 0,
    width = 300,
    height = 300,
    distx = 0,
    disty = 0,
    hw = width / 2,
    hh = height / 2,
    longest = Math.sqrt( ( hw * hw ) + ( hh * hh ) ),
    factor = 0.4,
    realdistance = 0,
    blur = [ 2, 9 ],
    shadowalpha = [ 3, 8 ],
    blurfactor = blur[1] / longest,
    shadowfactor = shadowalpha[1] / longest,
    output = document.querySelector('output'),
    increase = 0;

// resize the canvas
canvas.width = width;
canvas.height = height;
draw();

function draw() {

  if( !document.querySelector( '#animate' ).checked ) {
    distx = mouseX - hw;
    disty = mouseY - hh;
  } else {
    increase += 0.03;
    var distx = 80 * Math.cos( increase ) + 60 * Math.cos( increase * 2 );
    var disty = 100 * Math.sin( increase * 2 ) + 20 * Math.cos( increase );
  }
  
  realdistance = Math.sqrt( ( distx * distx ) + ( disty * disty ) );
  var currentblur = parseInt( blurfactor * realdistance, 10 );
  if ( currentblur < blur[ 0 ] ) {currentblur = blur[0];}
  var currentalpha = parseInt( shadowfactor * realdistance, 10 );
  if ( currentalpha < shadowalpha[ 0 ] ) { currentalpha = shadowalpha[0]; }

  c.clearRect( 0, 0, width, height );
  c.save();
  c.translate( hw, hh);

  if( document.querySelector ('#controlline').checked ){
    c.beginPath();
    c.strokeStyle = '#fff';
    c.moveTo( 0, 0 );
    c.lineTo( distx, disty );
    c.closePath();
    c.stroke();

    c.beginPath();
    c.strokeStyle = '#c00';
    c.moveTo( 0, 0 );
    c.lineTo( -distx * factor, -disty * factor );
    c.closePath();
    c.stroke();
  }

  c.beginPath();
  c.shadowOffsetX = -distx * factor;
  c.shadowOffsetY = -disty * factor;
  c.shadowBlur = currentblur;
  c.shadowColor = 'rgba(0,0,0,' + (1 - currentalpha / 10)  + ')';
  c.fillStyle = 'lime';
  var text = 'Text with shadow';
  c.font = "bold 24px sans-serif";
  var len = c.measureText( text );
  c.fillText( text, -len.width / 2, 12 );
  c.closePath();

  var grd = c.createRadialGradient(distx+10,disty-10,3,distx+10,disty-10,40);
  grd.addColorStop(0, "white");
  grd.addColorStop(1, "orange");
  c.fillStyle = grd;  
  c.shadowColor = 'rgba(0,0,0,0)';
  c.beginPath();
  c.arc( distx, disty, realdistance / 6 + 10 , 0, Math.PI*2, true );
  c.closePath();
  c.fill();
  c.restore();
  
  output.innerHTML = '<ul><li>x: ' + dec( distx ) +
                     '</li><li>y: ' + dec( disty ) + 
                     '</li><li>distance: ' + dec( realdistance ) +
                     '</li><li>shadowdx: ' + dec( distx * factor ) +
                     '</li><li>shadowy:  ' + dec( disty * factor ) +
                     '</li><li>blur: ' + currentblur + '</li><li>alpha: ' +
                      dec( 1 - currentalpha / 10 ) +'</li></ul>';

  if( document.querySelector( '#animate' ).checked ) {
    requestAnimationFrame( draw, 10 );
  }
}
function dec(n){
  return Math.round( n * 100 ) / 100;
}
// get the mouse position on the canvas (some browser trickery involved)
canvas.addEventListener( 'mousemove', function( event ) {
  if( event.offsetX ){
    mouseX = event.offsetX;
    mouseY = event.offsetY;
  } else {
    mouseX = event.pageX - event.target.offsetLeft;
    mouseY = event.pageY - event.target.offsetTop;
  }
  // call the draw function
  if( !document.querySelector( '#animate' ).checked ) {
    draw();
  }  
}, false );

document.querySelector( '#animate' ).addEventListener( 'click', draw, false);

</script>


</body>
</html>